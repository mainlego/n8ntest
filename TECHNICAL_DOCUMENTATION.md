# ๐ ะขะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั ัะธััะตะผั ัะฒะตะดะพะผะปะตะฝะธะน n8n

## 1. ะะปะณะพัะธัะผ ัะฐะฑะพัั ัะธััะตะผั

### 1.1 ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

```
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ
โ   Client    โโโโโโถโ     n8n     โโโโโโถโ  Supabase   โ
โ   (API)     โ     โ  Workflows  โ     โ  PostgreSQL โ
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ
                           โ
                           โผ
                    โโโโโโโโโโโโโโโ
                    โ Notificationโ
                    โ     API     โ
                    โโโโโโโโโโโโโโโ
```

### 1.2 ะัะฟะพะปัะทัะตะผัะต n8n ะฝะพะดั ะธ ะธั ะฟะพััะดะพะบ

#### Workflow #1: Schedule Notifications
1. **Webhook Node** - ะัะธะฝะธะผะฐะตั POST ะทะฐะฟัะพัั ะฝะฐ `/webhook/schedule-notification`
2. **Code Node (Validate and Log)** - ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั ะธ ะปะพะณะธัะพะฒะฐะฝะธะต
3. **Code Node (Calculate Schedule)** - ะะฐััะตั ะฒัะตะผะตะฝะธ ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธะน
4. **PostgreSQL Node** - ะกะพััะฐะฝะตะฝะธะต ะฒ ะฑะฐะทั ะดะฐะฝะฝัั Supabase
5. **Code Node (Prepare Response)** - ะคะพัะผะธัะพะฒะฐะฝะธะต ะพัะฒะตัะฐ

#### Workflow #2: Send Notifications (ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะฟัะฐะฒะบะฐ)
1. **Schedule Trigger Node** - ะะฐะฟััะบ ะบะฐะถะดัะต 30 ัะตะบัะฝะด
2. **PostgreSQL Node** - ะัะฑะพัะบะฐ pending ัะฒะตะดะพะผะปะตะฝะธะน
3. **IF Node** - ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะฒะตะดะพะผะปะตะฝะธะน
4. **Code Node (Prepare API Data)** - ะคะพัะผะธัะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะฟะพ ะขะ
5. **HTTP Request Node** - ะัะฟัะฐะฒะบะฐ ะฝะฐ API ัะฒะตะดะพะผะปะตะฝะธะน
6. **PostgreSQL Node** - ะะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ
7. **Code Node (Log Results)** - ะะพะณะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ

#### Workflow #3: Cancel Notifications
1. **Webhook Node** - ะัะธะฝะธะผะฐะตั DELETE ะทะฐะฟัะพัั ะฝะฐ `/webhook/cancel-notifications/:activity_id`
2. **Code Node (Extract ID)** - ะะทะฒะปะตัะตะฝะธะต activity_id
3. **PostgreSQL Node** - ะะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ ะฝะฐ 'cancelled'
4. **Code Node (Response)** - ะคะพัะผะธัะพะฒะฐะฝะธะต ะพัะฒะตัะฐ

### 1.3 ะคะพัะผะฐั API ะทะฐะฟัะพัะพะฒ ัะพะณะปะฐัะฝะพ ะขะ

#### ะัะพะดััะธะน ะทะฐะฟัะพั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั:
```json
{
  "activity_date": "2025-08-25",
  "activity_id": "evt_12345",
  "activity_time": "14:30",
  "activity_url": "https://example.com/manage/evt_12345",
  "activity_qr": "https://example.com/qr/evt_12345.png",
  "id": "user_67890"
}
```

#### ะััะพะดััะธะน ะทะฐะฟัะพั ัะฒะตะดะพะผะปะตะฝะธั (ะฝะฐะบะฐะฝัะฝะต):
```json
{
  "client_id": "user_67890",
  "message": "notification_evt_12345",
  "text": "ะะฐะฟะพะผะธะฝะฐะตะผ: ะทะฐะฒััะฐ ะฒ 14:30 ั ะฒะฐั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะพ ัะพะฑััะธะต",
  "button_url": "https://example.com/manage/evt_12345"
}
```

#### ะััะพะดััะธะน ะทะฐะฟัะพั ัะฒะตะดะพะผะปะตะฝะธั (ะทะฐ 3 ัะฐัะฐ):
```json
{
  "client_id": "user_67890",
  "message": "notification_evt_12345",
  "text": "ะกะพะฑััะธะต ะฝะฐัะฝะตััั ัะตัะตะท 3 ัะฐัะฐ ะฒ 14:30",
  "qr": "https://example.com/qr/evt_12345.png"
}
```

## 2. ะะพะฟะพะปะฝะธัะตะปัะฝะพะต ะะ

### 2.1 ะะฐ ัะตัะฒะตัะต n8n (Render.com):
- **n8n** (latest) - ะฟะปะฐััะพัะผะฐ ะฐะฒัะพะผะฐัะธะทะฐัะธะธ
- **PostgreSQL client** - ะดะปั ัะฐะฑะพัั ั ะะ
- **curl** - ะดะปั health checks

### 2.2 ะะฝะตัะฝะธะต ัะตัะฒะธัั:
- **Supabase PostgreSQL** - ััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั
- **Render.com** - ัะพััะธะฝะณ n8n
- **API ัะฒะตะดะพะผะปะตะฝะธะน** - ะฒะฝะตัะฝะธะน ัะตัะฒะธั ะพัะฟัะฐะฒะบะธ

## 3. ะะฑะตัะฟะตัะตะฝะธะต ะฒัะฟะพะปะฝะตะฝะธั ััะตะฑะพะฒะฐะฝะธะน

### 3.1 ะัะตะผั ะพัะฒะตัะฐ < 6 ัะตะบัะฝะด
- โ ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะฒ n8n
- โ ะะฝะดะตะบัั ะฒ ะะ ะฟะพ scheduled_time ะธ status
- โ Timeout ะฝะฐัััะพะตะฝ ะฝะฐ 6 ัะตะบัะฝะด ะฒ workflow settings
- โ ะะธะฝะธะผะฐะปัะฝะฐั ะปะพะณะธะบะฐ ะฒ webhook, ะพัะฝะพะฒะฝะฐั ัะฐะฑะพัะฐ ะฒ ัะพะฝะต

### 3.2 ะัะตะผั ะพัะฟัะฐะฒะบะธ < 2 ัะตะบัะฝะด
- โ Batch ะพะฑัะฐะฑะพัะบะฐ ะดะพ 10 ัะฒะตะดะพะผะปะตะฝะธะน ะทะฐ ัะฐะท
- โ HTTP timeout 2000ms ะดะปั API ะทะฐะฟัะพัะพะฒ
- โ ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะฒ n8n
- โ ะะตัะธัะพะฒะฐะฝะธะต ัะพะตะดะธะฝะตะฝะธะน ั ะะ

### 3.3 ะะฐัััะฐะฑะธััะตะผะพััั
- โ ะะพัะธะทะพะฝัะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฝะฐ Render
- โ ะะฝะดะตะบัะธัะพะฒะฐะฝะฝัะต ะทะฐะฟัะพัั ะบ ะะ
- โ ะะฐััะธัะธะพะฝะธัะพะฒะฐะฝะธะต ัะฐะฑะปะธั ะฟะพ ะดะฐัะต (ะพะฟัะธะพะฝะฐะปัะฝะพ)
- โ ะัะธััะบะฐ ััะฐััั ะทะฐะฟะธัะตะน ััะฝะบัะธะตะน cleanup_old_notifications()

### 3.4 ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
- โ HTTP ะบะพะดั: 200 (OK), 201 (Created), 400 (Bad Request), 404 (Not Found), 500 (Server Error)
- โ Retry ะผะตัะฐะฝะธะทะผ (3 ะฟะพะฟััะบะธ)
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพัะธะฑะพะบ ะฒ ะะ
- โ Graceful degradation ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ API

## 4. ะะตัั ะฑะตะทะพะฟะฐัะฝะพััะธ

### 4.1 ะััะตะฝัะธัะธะบะฐัะธั ะธ ะฐะฒัะพัะธะทะฐัะธั
```javascript
// Webhook ะทะฐัะธัะฐ ัะตัะตะท API ะบะปััะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
if (headers['X-API-Key'] !== process.env.WEBHOOK_API_KEY) {
  return { statusCode: 401, error: 'Unauthorized' };
}
```

### 4.2 ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
- โ ะัะพะฒะตัะบะฐ ะฒัะตั ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน
- โ ะะฐะปะธะดะฐัะธั ัะพัะผะฐัะพะฒ ะดะฐัั/ะฒัะตะผะตะฝะธ
- โ ะัะพะฒะตัะบะฐ ััะพ ัะพะฑััะธะต ะฒ ะฑัะดััะตะผ
- โ ะกะฐะฝะธัะธะทะฐัะธั ัะตัะตะท ะฟะฐัะฐะผะตััะธะทะพะฒะฐะฝะฝัะต ะทะฐะฟัะพัั

### 4.3 Rate Limiting
- โ Render ะฐะฒัะพะผะฐัะธัะตัะบะธะน rate limiting
- โ ะะฐะบัะธะผัะผ 10 ัะฒะตะดะพะผะปะตะฝะธะน ะทะฐ batch
- โ Throttling ัะตัะตะท n8n execution limits

### 4.4 ะะฐัะธัะฐ ะดะฐะฝะฝัั
- โ HTTPS ะดะปั ะฒัะตั ัะพะตะดะธะฝะตะฝะธะน
- โ Row Level Security ะฒ Supabase
- โ ะจะธััะพะฒะฐะฝะธะต ะฟะฐัะพะปะตะน ะะ
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฑะตะท sensitive ะดะฐะฝะฝัั

## 5. ะะพะณะธัะพะฒะฐะฝะธะต

### 5.1 ะกัััะบัััะฐ ะปะพะณะพะฒ
```javascript
{
  timestamp: "2025-08-20T10:30:00Z",
  operation_type: "schedule|send|cancel|error",
  activity_id: "evt_12345",
  user_id: "user_67890",
  execution_time_ms: 145,
  status_code: 201,
  ip_address: "192.168.1.1",
  request_data: {...},
  response_data: {...},
  error_message: null
}
```

### 5.2 ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั
- **INFO**: ะฃัะฟะตัะฝัะต ะพะฟะตัะฐัะธะธ
- **WARN**: ะะพะฒัะพัะฝัะต ะฟะพะฟััะบะธ
- **ERROR**: ะะตัะดะฐัะฝัะต ะพะฟะตัะฐัะธะธ
- **DEBUG**: ะะตัะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั (dev mode)

## 6. ะะพะฝะธัะพัะธะฝะณ ะธ ะผะตััะธะบะธ

### 6.1 ะะปััะตะฒัะต ะผะตััะธะบะธ
- ะะพะปะธัะตััะฒะพ ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝัั ัะฒะตะดะพะผะปะตะฝะธะน
- ะะพะปะธัะตััะฒะพ ะพัะฟัะฐะฒะปะตะฝะฝัั ัะฒะตะดะพะผะปะตะฝะธะน
- ะกัะตะดะฝะต ะฒัะตะผั ะฒัะฟะพะปะฝะตะฝะธั
- ะัะพัะตะฝั ะพัะธะฑะพะบ
- ะะฐะดะตัะถะบะฐ ะพัะฟัะฐะฒะบะธ

### 6.2 SQL ะทะฐะฟัะพัั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ
```sql
-- ะกัะฐัะธััะธะบะฐ ะฟะพ ััะฐัััะฐะผ
SELECT status, COUNT(*) FROM scheduled_notifications 
GROUP BY status;

-- ะกัะตะดะฝะตะต ะฒัะตะผั ะฒัะฟะพะปะฝะตะฝะธั
SELECT AVG(execution_time_ms) FROM notification_logs 
WHERE created_at > NOW() - INTERVAL '1 hour';

-- ะฃะฒะตะดะพะผะปะตะฝะธั ั ะทะฐะดะตัะถะบะพะน
SELECT * FROM scheduled_notifications 
WHERE status = 'pending' 
AND scheduled_time < NOW() - INTERVAL '5 minutes';
```

## 7. ะขะตััะธัะพะฒะฐะฝะธะต

### 7.1 Unit ัะตััั
- ะะฐะปะธะดะฐัะธั ะฒัะพะดะฝัั ะดะฐะฝะฝัั
- ะะฐััะตั ะฒัะตะผะตะฝะธ ัะฒะตะดะพะผะปะตะฝะธะน
- ะคะพัะผะธัะพะฒะฐะฝะธะต API ะทะฐะฟัะพัะพะฒ

### 7.2 Integration ัะตััั
- Webhook endpoints
- ะะฐะทะฐ ะดะฐะฝะฝัั ะพะฟะตัะฐัะธะธ
- API ะฒัะทะพะฒั

### 7.3 Load ัะตััั
- 1000 ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะฟัะพัะพะฒ
- ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะพัะฒะตัะฐ < 6 ัะตะบ
- ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะพัะฟัะฐะฒะบะธ < 2 ัะตะบ

## 8. Deployment

### 8.1 Environment Variables
```env
# Database
DATABASE_URL=postgresql://user:pass@host:5432/db
DB_SSL_MODE=require

# n8n
N8N_WEBHOOK_URL=https://n8ntest-uwxt.onrender.com
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=secure_password

# API
NOTIFICATION_API_URL=https://api.example.com/send
NOTIFICATION_API_TOKEN=bearer_token

# Security
WEBHOOK_API_KEY_SCHEDULE=random_key_1
WEBHOOK_API_KEY_CANCEL=random_key_2
```

### 8.2 CI/CD Pipeline
1. Git push to main branch
2. Render auto-deploy
3. Database migrations
4. Health check
5. Smoke tests

## 9. ะะตะทัะปััะฐัั ะธ ัะพะพัะฒะตัััะฒะธะต ะขะ

| ะขัะตะฑะพะฒะฐะฝะธะต | ะกัะฐััั | ะะตะฐะปะธะทะฐัะธั |
|------------|--------|------------|
| ะะปะฐะฝะธัะพะฒะฐะฝะธะต ัะฒะตะดะพะผะปะตะฝะธะน | โ | Webhook endpoint ั ะฒะฐะปะธะดะฐัะธะตะน |
| ะัะผะตะฝะฐ ัะฒะตะดะพะผะปะตะฝะธะน | โ | DELETE endpoint ะฟะพ activity_id |
| ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ | โ | Try-catch, retry, ะฟัะฐะฒะธะปัะฝัะต HTTP ะบะพะดั |
| ะะพะณะธัะพะฒะฐะฝะธะต | โ | ะะพะปะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฒ ะะ |
| ะะฐัััะฐะฑะธััะตะผะพััั | โ | Horizontal scaling ะฝะฐ Render |
| ะัะตะผั ะพัะฒะตัะฐ < 6 ัะตะบ | โ | ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ |
| ะัะตะผั ะพัะฟัะฐะฒะบะธ < 2 ัะตะบ | โ | ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต ะทะฐะฟัะพัั |
| ะคะพัะผะฐั API | โ | ะขะพัะฝะพะต ัะพะพัะฒะตัััะฒะธะต ะขะ |

## 10. ะะตะผะพะฝัััะฐัะธั

ะะปั ะดะตะผะพะฝัััะฐัะธะธ ัะฐะฑะพัั ัะธััะตะผั:

1. ะัะบัะพะนัะต `demo/index.html` ะฒ ะฑัะฐัะทะตัะต
2. ะะฐะฟะพะปะฝะธัะต ัะพัะผั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ัะพะฑััะธั
3. ะะฐะฑะปัะดะฐะนัะต ะทะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพัะฟัะฐะฒะบะพะน ัะฒะตะดะพะผะปะตะฝะธะน
4. ะัะพะฒะตัััะต ะปะพะณะธ ะธ ััะฐัะธััะธะบั
5. ะัะพัะตััะธััะนัะต ะพัะผะตะฝั ัะฒะตะดะพะผะปะตะฝะธะน

ะกะธััะตะผะฐ ะฟะพะปะฝะพัััั ัะพะพัะฒะตัััะฒัะตั ะฒัะตะผ ััะตะฑะพะฒะฐะฝะธัะผ ัะตัะฝะธัะตัะบะพะณะพ ะทะฐะดะฐะฝะธั.